<html>

<head>
  <title>Todo App</title>
</head>

<body>
  <form id="form">
    <input type="text" name="title" id="title" />
    <input type="submit" value="Create" />
  </form>
  <h1>Todos</h1>
  <ul id="todos">
    {% for todo in data %}
    <li>
      <input class="todo-completed" data-id="{{ todo.id }}" type="checkbox" {% if todo.completed %} checked
        {% endif %} />
      {{ todo.title }}
      <button data-id="{{ todo.id }}" class="delete-button">X</button>
    </li>
    {% endfor %}
    </li>
  </ul>

  <script>
    document.querySelectorAll('.todo-completed')
      .forEach(todo => {
        todo.onchange = (e) => {
          const id = e.target.dataset.id;
          const checked = e.target.checked;
          fetch(`/todos/${id}/update`, {
            method: 'PUT',
            body: JSON.stringify({
              'completed': checked,
            }),
            headers: {
              'Content-Type': 'application/json'
            }
          })
        }
      });

    document.querySelectorAll('.delete-button')
      .forEach(todo => {
        todo.onclick = (e) => {
          const id = e.target.dataset.id;
          fetch(`/todos/${id}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
        }
      });

    document.getElementById('form').onsubmit = (e) => {
      e.preventDefault();
      fetch('/todos/create', {
        method: 'POST',
        body: JSON.stringify({
          'title': document.getElementById('title').value || ""
        }),
        headers: {
          'Content-Type': 'application/json'
        }
      })
        .then(resp => resp.json())
        .then(resp => {
          console.log(resp);
          const todo = document.createElement('li');
          todo.innerHTML = resp.title;
          document.getElementById('todos').appendChild(todo);
        }
        )
    }
  </script>
</body>

</html>